<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">


    <changeSet id="schema-initial-version" author="tomacla">

        <createTable tableName="team">
            <column name="id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="country" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="team" columnNames="id"/>

        <createTable tableName="team_description">
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="address_postal_city" type="VARCHAR(255)"/>
            <column name="address_postal_code" type="VARCHAR(10)"/>
            <column name="address_street_line" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(2000)"/>
            <column name="phone_number" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="facebook" type="VARCHAR(255)"/>
            <column name="twitter" type="VARCHAR(255)"/>
            <column name="other" type="VARCHAR(2000)"/>
        </createTable>

        <addPrimaryKey tableName="team_description" columnNames="team_id"/>

        <createTable tableName="team_integration">
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="facebook_access_token" type="VARCHAR(300)"/>
            <column name="facebook_page_id" type="VARCHAR(100)"/>
        </createTable>

        <addPrimaryKey tableName="team_integration" columnNames="team_id"/>

        <createTable tableName="team_configuration">
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="timezone" type="VARCHAR(50)"/>
            <column name="default_page" type="VARCHAR(30)"/>
            <column name="feed_visible" type="BOOLEAN"/>
            <column name="rides_visible" type="BOOLEAN"/>
        </createTable>

        <createTable tableName="team_configuration_default_search_tags">
            <column name="team_configuration_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="default_search_tags" type="VARCHAR(255)"/>
        </createTable>

        <addPrimaryKey tableName="team_configuration" columnNames="team_id"/>

        <addForeignKeyConstraint baseTableName="team_integration"
                                 baseColumnNames="team_id"
                                 constraintName="fk_team_integration_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="team_configuration"
                                 baseColumnNames="team_id"
                                 constraintName="fk_team_configuration_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="team_description"
                                 baseColumnNames="team_id"
                                 constraintName="fk_team_description_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="map">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="posted_at" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="crossing" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="length" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="negative_elevation" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="positive_elevation" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="start_point_lat" type="DOUBLE"/>
            <column name="start_point_lng" type="DOUBLE"/>
            <column name="end_point_lat" type="DOUBLE"/>
            <column name="end_point_lng" type="DOUBLE"/>
            <column name="visible" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="wind_direction" type="VARCHAR(15)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="map" columnNames="id"/>

        <createIndex tableName="map" indexName="map_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="map"
                                 baseColumnNames="team_id"
                                 constraintName="fk_map_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="map_tags">
            <column name="map_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="tags" type="VARCHAR(255)"/>
        </createTable>

        <createIndex tableName="map_tags" indexName="map_tags_map_id">
            <column name="map_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="map_tags"
                                 baseColumnNames="map_id"
                                 constraintName="fk_map_tags_map_id"
                                 referencedTableName="map"
                                 referencedColumnNames="id"/>

        <createTable tableName="publication">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="VARCHAR(8000)">
                <constraints nullable="false"/>
            </column>
            <column name="imaged" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="published_status" type="VARCHAR(25)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="publication" columnNames="id"/>

        <createIndex tableName="publication" indexName="publication_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="publication"
                                 baseColumnNames="team_id"
                                 constraintName="fk_publication_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="ride">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(8000)">
                <constraints nullable="false"/>
            </column>
            <column name="imaged" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(25)">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="published_status" type="VARCHAR(25)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="ride" columnNames="id"/>

        <createIndex tableName="ride" indexName="ride_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="ride"
                                 baseColumnNames="team_id"
                                 constraintName="fk_ride_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="ride_group">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lower_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="upper_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="map_id" type="VARCHAR(255)"/>
            <column name="meeting_location" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="meeting_point_lat" type="DOUBLE"/>
            <column name="meeting_point_lng" type="DOUBLE"/>
            <column name="meeting_time" type="TIME">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ride_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="ride_group" columnNames="id"/>

        <createIndex tableName="ride_group" indexName="ride_group_ride_id">
            <column name="ride_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="ride_group"
                                 baseColumnNames="ride_id"
                                 constraintName="fk_ride_group_ride_id"
                                 referencedTableName="ride"
                                 referencedColumnNames="id"/>
        
        <createTable tableName="user_account">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="admin" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(255)"/>
            <column name="last_name" type="VARCHAR(255)"/>
            <column name="strava_id" type="BIGINT"/>
            <column name="strava_user_name" type="VARCHAR(255)"/>
            <column name="city" type="VARCHAR(255)"/>
            <column name="profile_image" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(150)"/>

        </createTable>

        <addPrimaryKey tableName="user_account" columnNames="id"/>

        <createTable tableName="ride_group_participant">
            <column name="ride_group_id" type="VARCHAR(255)"/>
            <column name="user_id" type="VARCHAR(255)"/>
        </createTable>

        <createTable tableName="user_role">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="user_role" columnNames="id"/>

        <createIndex tableName="user_role" indexName="user_role_user_id">
            <column name="user_id"/>
        </createIndex>

        <createIndex tableName="user_role" indexName="user_role_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="user_role"
                                 baseColumnNames="user_id"
                                 constraintName="fk_user_role_user_id"
                                 referencedTableName="user_account"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="user_role"
                                 baseColumnNames="team_id"
                                 constraintName="fk_user_role_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="ride_template">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(8000)"/>
            <column name="type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="ride_template" columnNames="id"/>

        <createIndex tableName="ride_template" indexName="ride_template_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="ride_template"
                                 baseColumnNames="team_id"
                                 constraintName="fk_ride_template_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="ride_group_template">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lower_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="upper_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="meeting_location" type="VARCHAR(255)"/>
            <column name="meeting_point_lat" type="DOUBLE"/>
            <column name="meeting_point_lng" type="DOUBLE"/>
            <column name="meeting_time" type="TIME"/>
            <column name="ride_template_id" type="VARCHAR(255)"/>
        </createTable>

        <addPrimaryKey tableName="ride_group_template" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_group_template"
                                 baseColumnNames="ride_template_id"
                                 constraintName="fk_ride_group_template_ride_template_id"
                                 referencedTableName="ride_template"
                                 referencedColumnNames="id"/>

        <createTable tableName="oauth2_authorized_client">
            <column name="client_registration_id" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="principal_name" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_value" type="longblob">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_issued_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_expires_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="access_token_scopes" type="varchar(1000)"/>
            <column name="refresh_token_value" type="longblob"/>
            <column name="refresh_token_issued_at" type="timestamp"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="oauth2_authorized_client" columnNames="client_registration_id, principal_name"/>

        <createTable tableName="SPRING_SESSION">
            <column name="PRIMARY_ID" type="varchar(36)">
                <constraints nullable="false"/>
            </column>
            <column name="SESSION_ID" type="varchar(36)">
                <constraints nullable="false"/>
            </column>
            <column name="CREATION_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_ACCESS_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="MAX_INACTIVE_INTERVAL" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="EXPIRY_TIME" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="PRINCIPAL_NAME" type="varchar(100)"/>
        </createTable>

        <addPrimaryKey tableName="SPRING_SESSION" columnNames="PRIMARY_ID"/>

        <createIndex tableName="SPRING_SESSION" indexName="SPRING_SESSION_ID" unique="true">
            <column name="SESSION_ID"/>
        </createIndex>

        <createIndex tableName="SPRING_SESSION" indexName="SPRING_SESSION_TIME">
            <column name="EXPIRY_TIME"/>
        </createIndex>

        <createIndex tableName="SPRING_SESSION" indexName="SPRING_SESSION_NAME">
            <column name="PRINCIPAL_NAME"/>
        </createIndex>

        <createTable tableName="SPRING_SESSION_ATTRIBUTES">
            <column name="SESSION_PRIMARY_ID" type="varchar(36)">
                <constraints nullable="false"/>
            </column>
            <column name="ATTRIBUTE_NAME" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="ATTRIBUTE_BYTES" type="LONGVARBINARY">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="SPRING_SESSION_ATTRIBUTES" columnNames="SESSION_PRIMARY_ID, ATTRIBUTE_NAME"/>

        <addForeignKeyConstraint baseTableName="SPRING_SESSION_ATTRIBUTES"
                                 baseColumnNames="SESSION_PRIMARY_ID"
                                 constraintName="SPRING_SESSION_ATTRIBUTES_FK"
                                 referencedTableName="SPRING_SESSION"
                                 referencedColumnNames="PRIMARY_ID"
                                 onDelete="CASCADE"/>

        <createView viewName="feed" replaceIfExists="true">
            select id as id, team_id as team_id, 'RIDE' as type, published_at as published_at, title as title,
            description as content, imaged as imaged FROM ride where published_status = 'PUBLISHED'
            UNION
            select id as id, team_id as team_id, 'PUBLICATION' as type, published_at as published_at, title as title,
            content as content, imaged as imaged FROM publication where published_status = 'PUBLISHED'
        </createView>

    </changeSet>

    <changeSet id="GITHUB-40-CROSS-FEED-TEAM" author="tomacla">

        <dropView viewName="feed" />

        <createView viewName="feed" replaceIfExists="true">
            select r.id as id, r.team_id as team_id, t.name as team_name, 'RIDE' as type, r.published_at as published_at, r.title as title,
            r.description as content, r.imaged as imaged FROM ride r, team t where t.id = r.team_id and r.published_status = 'PUBLISHED'
            UNION
            select p.id as id, p.team_id as team_id, t.name as team_name, 'PUBLICATION' as type, p.published_at as published_at, p.title as title,
            p.content as content, p.imaged as imaged FROM publication p, team t where t.id = p.team_id and p.published_status = 'PUBLISHED'
        </createView>

    </changeSet>

    <changeSet id="FIX-DUPLICATE-STRAVA" author="tomacla">

        <addUniqueConstraint
                columnNames="strava_id"
                constraintName="unique_strava_id"
                tableName="user_account"
        />

    </changeSet>
    
    <changeSet id="GITHUB-50-add-exposed-domain" author="tomacl">

        <addColumn tableName="team_configuration">
            <column name="domain" type="VARCHAR(100)"/>
        </addColumn>

    </changeSet>

    <changeSet id="GITHUB-47-add-custom-markdown-page" author="tomacla">

        <addColumn tableName="team_configuration">
            <column name="markdown_page" type="TEXT"/>
        </addColumn>

    </changeSet>

    <changeSet id="GITHUB-53-add-increment-template" author="tomacla">

        <addColumn tableName="ride_template">
            <column name="increment" type="INT"/>
        </addColumn>

    </changeSet>

    <changeSet id="facebook-group-details-control" author="tomacla">

        <addColumn tableName="team_integration">
            <column name="facebook_group_details" type="BOOLEAN"/>
        </addColumn>

        <sql>update team_integration set facebook_group_details = FALSE</sql>

    </changeSet>

    <changeSet id="GITHUB-68-ADD-MATTERMOST" author="tomacla">

        <addColumn tableName="team_integration">
            <column name="mattermost_api_token" type="VARCHAR(100)"/>
            <column name="mattermost_channel_id" type="VARCHAR(100)"/>
            <column name="mattermost_api_endpoint" type="VARCHAR(100)"/>
        </addColumn>

    </changeSet>

    <changeSet id="GITHUB-70-FACEBOOK-INTEGRATION" author="tomacla">

        <dropColumn tableName="team_integration" columnName="facebook_access_token" />

        <createTable tableName="admin_parameters">
            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="VARCHAR(500)" />
        </createTable>

        <addPrimaryKey tableName="admin_parameters" columnNames="name"/>

    </changeSet>

    <changeSet id="ADD-HEATMAP" author="tomacla">
        <addColumn tableName="team_integration">
            <column name="heatmap_center_lat" type="DOUBLE"/>
            <column name="heatmap_center_lng" type="DOUBLE"/>
        </addColumn>
    </changeSet>

    <changeSet id="ADD-HEATMAP-PARAMETER" author="tomacla">
        <addColumn tableName="team_integration">
            <column name="heatmap_display" type="BOOLEAN"/>
        </addColumn>
        <sql>update team_integration set heatmap_display = false</sql>
    </changeSet>
    
    <changeSet id="GITHUB-77-TRIPS" author="tomacla">

        <createTable tableName="trip">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="lower_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="upper_speed" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="meeting_location" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="meeting_point_lat" type="DOUBLE"/>
            <column name="meeting_point_lng" type="DOUBLE"/>
            <column name="meeting_time" type="TIME">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(8000)">
                <constraints nullable="false"/>
            </column>
            <column name="imaged" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(25)">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
            <column name="published_status" type="VARCHAR(25)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="trip" columnNames="id"/>

        <createIndex tableName="trip" indexName="trip_team_id">
            <column name="team_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="trip"
                                 baseColumnNames="team_id"
                                 constraintName="fk_trip_team"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <createTable tableName="trip_stage">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="map_id" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="trip_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="trip_stage" columnNames="id"/>

        <createIndex tableName="trip_stage" indexName="trip_stage_trip_id">
            <column name="trip_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="trip_stage"
                                 baseColumnNames="trip_id"
                                 constraintName="fk_trip_stage_trip_id"
                                 referencedTableName="trip"
                                 referencedColumnNames="id"/>

        <createTable tableName="trip_participant">
            <column name="trip_id" type="VARCHAR(255)"/>
            <column name="user_id" type="VARCHAR(255)"/>
        </createTable>

        <addColumn tableName="team_configuration">
            <column name="trips_visible" type="BOOLEAN"/>
        </addColumn>

        <sql>update team_configuration set trips_visible = false</sql>

        <dropView viewName="feed" />

        <createView viewName="feed" replaceIfExists="true">
            select r.id as id, r.team_id as team_id, t.name as team_name, 'RIDE' as type, r.published_at as published_at, r.title as title,
            r.description as content, r.imaged as imaged FROM ride r, team t where t.id = r.team_id and r.published_status = 'PUBLISHED'
            UNION
            select p.id as id, p.team_id as team_id, t.name as team_name, 'PUBLICATION' as type, p.published_at as published_at, p.title as title,
            p.content as content, p.imaged as imaged FROM publication p, team t where t.id = p.team_id and p.published_status = 'PUBLISHED'
            UNION
            select tr.id as id, tr.team_id as team_id, t.name as team_name, 'TRIP' as type, tr.published_at as published_at, tr.title as title,
            tr.description as content, tr.imaged as imaged FROM trip tr, team t where t.id = tr.team_id and tr.published_status = 'PUBLISHED'
        </createView>

    </changeSet>

    <changeSet id="GITHUB-85-BROADCAST-TUNING" author="tomacla">

        <addColumn tableName="team_integration">
            <column name="facebook_publish_trips" type="BOOLEAN"/>
            <column name="facebook_publish_rides" type="BOOLEAN"/>
            <column name="facebook_publish_publications" type="BOOLEAN"/>
            <column name="mattermost_publish_trips" type="BOOLEAN"/>
            <column name="mattermost_publish_rides" type="BOOLEAN"/>
            <column name="mattermost_publish_publications" type="BOOLEAN"/>
        </addColumn>

        <sql>update team_integration set facebook_publish_publications = false, facebook_publish_trips = false, facebook_publish_rides = false</sql>
        <sql>update team_integration set facebook_publish_trips = true where facebook_page_id is not null</sql>
        <sql>update team_integration set facebook_publish_rides = true where facebook_page_id is not null</sql>

        <sql>update team_integration set mattermost_publish_publications = false, mattermost_publish_trips = false, mattermost_publish_rides = false</sql>
        <sql>update team_integration set mattermost_publish_trips = true where mattermost_api_token is not null</sql>
        <sql>update team_integration set mattermost_publish_rides = true where mattermost_api_token is not null</sql>

        <addColumn tableName="user_account">
            <column name="email_publish_trips" type="BOOLEAN"/>
            <column name="email_publish_rides" type="BOOLEAN"/>
            <column name="email_publish_publications" type="BOOLEAN"/>
        </addColumn>

        <sql>update user_account set email_publish_publications = false, email_publish_trips = false, email_publish_rides = false</sql>
        <sql>update user_account set email_publish_rides = true where email is not null</sql>
        <sql>update user_account set email_publish_trips = true where email is not null</sql>

    </changeSet>

    <changeSet id="GITHUB-79-FEED-DETAILS" author="tomacla">

        <dropView viewName="feed" />

        <createView viewName="feed" replaceIfExists="true">
            select r.id as id, r.team_id as team_id, t.name as team_name, 'RIDE' as type, r.published_at as published_at, r.date as date, r.title as title,
            r.description as content, r.imaged as imaged FROM ride r, team t where t.id = r.team_id and r.published_status = 'PUBLISHED'
            UNION
            select p.id as id, p.team_id as team_id, t.name as team_name, 'PUBLICATION' as type, p.published_at as published_at, NULL as date, p.title as title,
            p.content as content, p.imaged as imaged FROM publication p, team t where t.id = p.team_id and p.published_status = 'PUBLISHED'
            UNION
            select tr.id as id, tr.team_id as team_id, t.name as team_name, 'TRIP' as type, tr.published_at as published_at, tr.start_date as date, tr.title as title,
            tr.description as content, tr.imaged as imaged FROM trip tr, team t where t.id = tr.team_id and tr.published_status = 'PUBLISHED'
        </createView>

        <createView viewName="feed_badges" replaceIfExists="true">
            select * from (select rg.ride_id as feed_id, ROW_NUMBER() over (ORDER BY rg.ride_id, rg.meeting_time, rg.name) || '-' || rg.name as badges FROM ride_group rg, ride r where r.id = rg.ride_id and r.published_status = 'PUBLISHED') as data1
            UNION
            select * from (select ts.trip_id as feed_id, ROW_NUMBER() over (ORDER BY ts.trip_id, ts.date, ts.name) || '-' || ts.name as badges FROM trip_stage ts, trip t where t.id = ts.trip_id and t.published_status = 'PUBLISHED') as data2
        </createView>

    </changeSet>

    <changeSet id="GITHUB-80-team-visibility" author="tomacla">

        <addColumn tableName="team">
            <column name="visibility" type="VARCHAR(50)" />
        </addColumn>

        <sql>update team set visibility = 'PUBLIC'</sql>

    </changeSet>

    <changeSet id="GITHUB-89-permalinks" author="tomacla">

        <addColumn tableName="ride">
            <column name="permalink" type="VARCHAR(255)" />
        </addColumn>

        <addColumn tableName="trip">
            <column name="permalink" type="VARCHAR(255)" />
        </addColumn>

        <addColumn tableName="map">
            <column name="permalink" type="VARCHAR(255)" />
        </addColumn>

       <dropForeignKeyConstraint baseTableName="map_tags" constraintName="fk_map_tags_map_id" />

        <sql>update map set permalink = id</sql>
        <sql>update map set id = md5(random()::text || clock_timestamp()::text)::uuid::text</sql>

        <sql>update ride_group set map_id = m.id from map m where map_id is not null and m.permalink = map_id</sql>
        <sql>update trip_stage set map_id = m.id from map m where map_id is not null and m.permalink = map_id</sql>
        <sql>update map_tags set map_id = m.id from map m where m.permalink = map_id</sql>

        <addUniqueConstraint
                columnNames="permalink"
                constraintName="ride_permalink"
                tableName="ride"
        />

        <addUniqueConstraint
                columnNames="permalink"
                constraintName="map_permalink"
                tableName="map"
        />

        <addUniqueConstraint
                columnNames="permalink"
                constraintName="trip_permalink"
                tableName="trip"
        />

        <addForeignKeyConstraint baseTableName="map_tags"
                                 baseColumnNames="map_id"
                                 constraintName="fk_map_tags_map_id"
                                 referencedTableName="map"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="GITHUB-89-permalinks-enhancement" author="tomacla">

        <addForeignKeyConstraint baseTableName="ride_group"
                                 baseColumnNames="map_id"
                                 constraintName="fk_ride_group_map"
                                 referencedTableName="map"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip_stage"
                                 baseColumnNames="map_id"
                                 constraintName="fk_trip_stage_map"
                                 referencedTableName="map"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="GITHUB-89-permalinks-in-feed" author="tomacla">

        <dropView viewName="feed" />

        <createView viewName="feed" replaceIfExists="true">
            select r.id as id, r.permalink as permalink, r.team_id as team_id, t.name as team_name, 'RIDE' as type, r.published_at as published_at, r.date as date, r.title as title,
            r.description as content, r.imaged as imaged FROM ride r, team t where t.id = r.team_id and r.published_status = 'PUBLISHED'
            UNION
            select p.id as id, NULL as permalink, p.team_id as team_id, t.name as team_name, 'PUBLICATION' as type, p.published_at as published_at, NULL as date, p.title as title,
            p.content as content, p.imaged as imaged FROM publication p, team t where t.id = p.team_id and p.published_status = 'PUBLISHED'
            UNION
            select tr.id as id, tr.permalink as permalink, tr.team_id as team_id, t.name as team_name, 'TRIP' as type, tr.published_at as published_at, tr.start_date as date, tr.title as title,
            tr.description as content, tr.imaged as imaged FROM trip tr, team t where t.id = tr.team_id and tr.published_status = 'PUBLISHED'
        </createView>

    </changeSet>

    <changeSet id="GITHUB-83-add-oauth2" author="tomacla">

        <addColumn tableName="user_account">
            <column name="facebook_id" type="VARCHAR(100)" />
        </addColumn>

        <addColumn tableName="user_account">
            <column name="google_id" type="VARCHAR(100)" />
        </addColumn>

    </changeSet>

    <changeSet id="GITHUB-41-ride-trip-messages" author="tomacla">

        <createTable tableName="ride_message">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ride_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="VARCHAR(2000)">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="ride_message" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_message"
                                 baseColumnNames="team_id"
                                 constraintName="fk_ride_message_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_message"
                                 baseColumnNames="ride_id"
                                 constraintName="fk_ride_message_id"
                                 referencedTableName="ride"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_message"
                                 baseColumnNames="user_id"
                                 constraintName="fk_ride_message_user_id"
                                 referencedTableName="user_account"
                                 referencedColumnNames="id"/>

        <createTable tableName="trip_message">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="trip_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="VARCHAR(2000)">
                <constraints nullable="false"/>
            </column>
            <column name="published_at" type="timestamp with time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="trip_message" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip_message"
                                 baseColumnNames="team_id"
                                 constraintName="fk_trip_message_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip_message"
                                 baseColumnNames="trip_id"
                                 constraintName="fk_trip_message_id"
                                 referencedTableName="trip"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip_message"
                                 baseColumnNames="user_id"
                                 constraintName="fk_trip_message_user_id"
                                 referencedTableName="user_account"
                                 referencedColumnNames="id"/>


    </changeSet>

    <changeSet id="add-instagram-field" author="tomacla">
        <addColumn tableName="team_description">
            <column name="instagram" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="add-mattermost-notification-message" author="tomacla">
        <addColumn tableName="team_integration">
            <column name="mattermost_message_channel_id" type="VARCHAR(100)"/>
        </addColumn>
    </changeSet>

    <changeSet id="remove-visible-map" author="tomacla">
        <dropColumn tableName="map" columnName="visible" />
    </changeSet>

    <changeSet id="remove-profile-image" author="tomacla">
        <dropColumn tableName="user_account" columnName="profile_image" />
    </changeSet>

    <changeSet id="add-start-end-place" author="tomacla">

        <createTable tableName="place">

            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="VARCHAR(900)">
                <constraints nullable="false"/>
            </column>
            <column name="link" type="VARCHAR(500)" />
            <column name="point_lat" type="DOUBLE"/>
            <column name="point_lng" type="DOUBLE"/>

        </createTable>

        <addPrimaryKey tableName="place" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="place"
                                 baseColumnNames="team_id"
                                 constraintName="fk_place_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <sql>
            insert into place
            select distinct on (rg.ride_id) rg.ride_id || 'r', r.team_id, rg.meeting_location, rg.meeting_location, NULL, rg.meeting_point_lat, rg.meeting_point_lng
            from ride_group rg, ride r where r.id = rg.ride_id and meeting_location is not null order by rg.ride_id
        </sql>

        <sql>
            insert into place
            select t.id || 't', t.team_id, t.meeting_location, t.meeting_location, NULL, t.meeting_point_lat, t.meeting_point_lng
            from trip t where meeting_location is not null;
        </sql>

        <sql>
            insert into place
            select distinct on (rg.ride_template_id) rg.ride_template_id || 'rt', r.team_id, rg.meeting_location, rg.meeting_location, NULL, rg.meeting_point_lat, rg.meeting_point_lng
            from ride_group_template rg, ride_template r where r.id = rg.ride_template_id and meeting_location is not null order by rg.ride_template_id
        </sql>

        <dropColumn tableName="ride_group" columnName="meeting_location" />
        <dropColumn tableName="ride_group" columnName="meeting_point_lat" />
        <dropColumn tableName="ride_group" columnName="meeting_point_lng" />
        <dropColumn tableName="trip" columnName="meeting_location" />
        <dropColumn tableName="trip" columnName="meeting_point_lat" />
        <dropColumn tableName="trip" columnName="meeting_point_lng" />
        <dropColumn tableName="ride_group_template" columnName="meeting_location" />
        <dropColumn tableName="ride_group_template" columnName="meeting_point_lat" />
        <dropColumn tableName="ride_group_template" columnName="meeting_point_lng" />

        <addColumn tableName="ride">
            <column name="start_place_id" type="VARCHAR(255)" />
            <column name="end_place_id" type="VARCHAR(255)" />
        </addColumn>

        <addColumn tableName="trip">
            <column name="start_place_id" type="VARCHAR(255)" />
            <column name="end_place_id" type="VARCHAR(255)" />
        </addColumn>

        <addColumn tableName="ride_template">
            <column name="start_place_id" type="VARCHAR(255)" />
            <column name="end_place_id" type="VARCHAR(255)" />
        </addColumn>

        <addForeignKeyConstraint baseTableName="ride"
                                 baseColumnNames="start_place_id"
                                 constraintName="fk_ride_start_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride"
                                 baseColumnNames="end_place_id"
                                 constraintName="fk_ride_end_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip"
                                 baseColumnNames="start_place_id"
                                 constraintName="fk_trip_start_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="trip"
                                 baseColumnNames="end_place_id"
                                 constraintName="fk_trip_end_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_template"
                                 baseColumnNames="start_place_id"
                                 constraintName="fk_ride_template_start_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="ride_template"
                                 baseColumnNames="end_place_id"
                                 constraintName="fk_ride_template_end_place_id"
                                 referencedTableName="place"
                                 referencedColumnNames="id"/>

        <sql>update ride set start_place_id = id || 'r' where id || 'r' in (select id from place)</sql>
        <sql>update trip set start_place_id = id || 't' where id || 't' in (select id from place)</sql>
        <sql>update ride_template set start_place_id = id || 'rt' where id || 'rt' in (select id from place)</sql>

    </changeSet>

    <changeSet id="add-team-type" author="tomacla">

        <addColumn tableName="team">
            <column name="type" type="VARCHAR(30)" />
        </addColumn>

        <sql>update team set type = 'BIKE'</sql>

    </changeSet>

    <changeSet id="FIX-DUPLICATE-OPENID" author="tomacla">

        <addUniqueConstraint
                columnNames="google_id"
                constraintName="unique_google_id"
                tableName="user_account"
        />

        <addUniqueConstraint
                columnNames="facebook_id"
                constraintName="unique_facebook_id"
                tableName="user_account"
        />

        <addUniqueConstraint
                columnNames="email"
                constraintName="unique_email"
                tableName="user_account"
        />

    </changeSet>

    <changeSet id="factorizing-messages" author="tomacla">

        <addColumn tableName="ride_message">
            <column name="type" type="VARCHAR(20)" />
            <column name="reply_to_id" type="VARCHAR(255)" />
        </addColumn>

        <sql>update ride_message set type='RIDE'</sql>

        <dropForeignKeyConstraint baseTableName="ride_message" constraintName="fk_ride_message_id" />

        <renameColumn tableName="ride_message" oldColumnName="ride_id" newColumnName="target_id" />
        <renameTable oldTableName="ride_message" newTableName="message" />

        <sql>insert into message(id, team_id, target_id, user_id, content, published_at, type)
        select id, team_id, trip_id, user_id, content, published_at, 'TRIP' from trip_message</sql>

        <dropTable tableName="trip_message" />

    </changeSet>

    <changeSet id="add-element-reaction" author="tomacla">


        <createTable tableName="reaction">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="target_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="VARCHAR(5)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="reaction" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="reaction"
                                 baseColumnNames="team_id"
                                 constraintName="fk_reaction_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="reaction"
                                 baseColumnNames="user_id"
                                 constraintName="fk_reaction_user_id"
                                 referencedTableName="user_account"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="remove-feed-view" author="tomacla">
        <dropView viewName="feed" />
    </changeSet>

    <changeSet id="change-default-page" author="tomacla">
        <sql>update team_configuration set default_page = 'FEED' where default_page != 'MAPS'</sql>
    </changeSet>

    <changeSet id="simplify-structure" author="tomacla">

        <dropColumn tableName="team_configuration" columnName="rides_visible" />
        <dropColumn tableName="team_configuration" columnName="trips_visible" />
        <dropColumn tableName="team_configuration" columnName="default_page" />
        <dropColumn tableName="trip" columnName="lower_speed" />
        <dropColumn tableName="trip" columnName="upper_speed" />
        <dropColumn tableName="ride_group" columnName="lower_speed" />
        <renameColumn tableName="ride_group" oldColumnName="upper_speed" newColumnName="average_speed"  />
        <dropColumn tableName="ride_group_template" columnName="lower_speed" />
        <renameColumn tableName="ride_group_template" oldColumnName="upper_speed" newColumnName="average_speed"  />

    </changeSet>

    <changeSet id="unique-reaction-constrait" author="tomacla">

        <addUniqueConstraint
                columnNames="target_id, user_id"
                constraintName="unique_reaction_user"
                tableName="reaction"
        />

    </changeSet>

    <changeSet id="add-notification-system" author="tomacla">

        <createTable tableName="notification">
            <column name="id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(100)" >
                <constraints nullable="false"/>
            </column>
            <column name="team_id" type="VARCHAR(20)" >
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(50)" >
                <constraints nullable="false"/>
            </column>
            <column name="element_id" type="VARCHAR(100)" />
            <column name="viewed" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="DATE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="notification" columnNames="id"/>

        <addForeignKeyConstraint baseTableName="notification"
                                 baseColumnNames="team_id"
                                 constraintName="fk_notification_team_id"
                                 referencedTableName="team"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="hide-or-show-reaction" author="tomacla">

        <addColumn tableName="team_configuration">
            <column name="reaction_visible" type="BOOLEAN"/>
        </addColumn>

        <sql>update team_configuration set reaction_visible = FALSE</sql>

    </changeSet>

    <changeSet id="favorites-maps" author="tomacla">

        <createTable tableName="map_favorite">
            <column name="map_id" type="VARCHAR(255)" />
            <column name="user_id" type="VARCHAR(255)" />
        </createTable>

        <addPrimaryKey tableName="map_favorite" columnNames="map_id, user_id"/>

        <addForeignKeyConstraint baseTableName="map_favorite"
                                 baseColumnNames="map_id"
                                 constraintName="fk_map_favorite_id"
                                 referencedTableName="map"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="map_favorite"
                                 baseColumnNames="user_id"
                                 constraintName="fk_map_favorite_user_id"
                                 referencedTableName="user_account"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="github-189-startend-places" author="tomacla">

        <addColumn tableName="place">
            <column name="start_place" type="BOOLEAN" />
            <column name="end_place" type="BOOLEAN" />
        </addColumn>

        <sql>update place set start_place = TRUE, end_place = TRUE</sql>

    </changeSet>

</databaseChangeLog>